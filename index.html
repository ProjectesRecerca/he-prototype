
<!--          data-client_id="871231787095-ug0o6pu89sn0t6i97s0nagakohighot8.apps.googleusercontent.com"
          -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Horizon Europe WP26-27 – Call Finder</title>

  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- ================= LOGIN ================= -->

<div id="login" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-10 rounded-xl shadow-lg text-center w-full max-w-md">
    <img src="./logo.png" class="mx-auto mb-6 h-20" />
    <h1 class="text-2xl font-bold mb-2">Horizon Europe WP26-27</h1>
    <p class="text-sm text-gray-500 mb-6">Servei de Recerca – UPF</p>

    <div
      id="g_id_onload"
      data-client_id="871231787095-ug0o6pu89sn0t6i97s0nagakohighot8.apps.googleusercontent.com"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>

    <div class="flex justify-center">
      <div class="g_id_signin" data-size="large"></div>
    </div>
  </div>
</div>

<!-- ================= PRIVATE APP ================= -->

<div id="private" class="hidden max-w-7xl mx-auto p-6">

  <!-- Header -->
  <div class="flex items-center gap-4 mb-6">
    <img src="./logo.png" class="h-12" />
    <div>
      <h1 class="text-3xl font-bold">Horizon Europe WP26-27</h1>
      <h2 class="text-gray-600">Call Finder</h2>
    </div>
  </div>

  <!-- Description -->
  <div class="bg-white rounded-xl shadow p-4 mb-6 text-sm text-gray-700">
    <p class="mb-2">
      This tool helps UPF researchers identify relevant Horizon Europe calls.
    </p>
    <ul class="list-disc ml-5 space-y-1">
      <li>Select one or more <b>Disciplines</b> and/or <b>Research Fields</b></li>
      <li>Optionally introduce keywords separated by <code>;</code></li>
      <li>Click on a call to view its details on the right panel</li>
    </ul>
  </div>

  <!-- Keyword search-->
<div class="flex gap-2 mt-2">
  <input
    id="keyword-input"
    type="text"
    placeholder='energy; machine learning'
    class="w-full border rounded px-2 py-1"
  />
  <button
    id="search-btn"
    class="px-4 py-1 bg-blue-600 text-white rounded"
    onclick="updateCalls()"
  >
    Search
  </button>
</div>

  <!-- MAIN LAYOUT -->
  <div class="flex gap-6">

    <!-- LEFT COLUMN -->
    <div class="w-3/4">

      <!-- Discipline -->
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <h3 class="font-bold mb-3">Discipline</h3>
        <div id="discipline-container" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Research Fields -->
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <h3 class="font-bold mb-3">Research Fields</h3>
        <div id="field-container" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Calls -->
      <div id="calls-block" class="bg-white rounded-xl shadow p-4 mb-6">
        <h3 id="calls-title" class="font-bold mb-3">Calls (0)</h3>
        <div id="calls-container" class="flex flex-col gap-2"></div>
      </div>
    </div>

    <!-- RIGHT COLUMN – CALL DETAIL -->
     <div id="call-details-panel"
     class="w-1/4">
      <div class="bg-white rounded-xl shadow p-4 sticky top-6">
        <h3 class="text-lg font-semibold mb-2">Call details</h3>
      <div id="call-details" class="text-sm space-y-1">
        <div><strong>Call ID:</strong> <em id="detail-id"></em></div>
        <div><strong>Call Title:</strong> <em id="detail-title"></em></div>
        <div><strong>Type of Action:</strong> <em id="detail-action"></em></div>
        <div><strong>Opening Date:</strong> <em id="detail-opening"></em></div>
        <div><strong>Deadline:</strong> <em id="detail-deadline"></em></div>
      </div>
      <div class="mt-4">
        <strong>Summary</strong>
        <p id="detail-summary" class="mt-1 text-justify text-sm"></p>
          Select a call to see its details.
        </p>
      </div>
    </div>

  </div>
</div>

<script>
let excelData = [];
let selectedDisciplines = new Set();
let selectedResearchFields = new Set();
let selectedCallButton = null;


function excelDateToString(value) {
  if (!value) return "";
  if (typeof value === "string") return value;

  const date = new Date(Math.round((value - 25569) * 86400 * 1000));
  const d = String(date.getDate()).padStart(2, "0");
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const y = date.getFullYear();
  return `${d}/${m}/${y}`;
}

/* LOGIN */
function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split(".")[1]));
  const email = payload.email;

  if (!email.endsWith("@upf.edu")) {
    alert("Restricted access to institutional personnel");
    return;
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("private").style.display = "block";

  loadExcel();
}

/* EXCEL */
function loadExcel() {
  fetch("./horizon_calls.xlsx")
    .then(r => r.arrayBuffer())
    .then(data => {
      const wb = XLSX.read(data, { type: "array" });
      excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      renderDisciplines();
      renderResearchFields();
      updateCalls();
    });
}

/* RENDER DISCIPLINES */
function renderDisciplines() {
  const c = document.getElementById("discipline-container");
  c.innerHTML = "";
  [...new Set(excelData.map(r => r.Cluster))].sort().forEach(d => {
    const b = document.createElement("button");
    b.textContent = d;
    b.className = "px-3 py-1 border rounded";
    b.onclick = () => {
      selectedDisciplines.has(d) ? selectedDisciplines.delete(d) : selectedDisciplines.add(d);
      b.classList.toggle("bg-blue-600");
      b.classList.toggle("text-white");
      renderResearchFields();
      updateCalls();
    };
    c.appendChild(b);
  });
}

/* RENDER FIELDS */
function renderResearchFields() {
  const c = document.getElementById("field-container");
  c.innerHTML = "";
  let rows = selectedDisciplines.size
    ? excelData.filter(r => selectedDisciplines.has(r.Cluster))
    : excelData;

  const fields = new Set();
  rows.forEach(r =>
    r["Research Fields"].split(";").map(f => f.trim()).forEach(f => fields.add(f))
  );

  [...fields].sort().forEach(f => {
    const b = document.createElement("button");
    b.textContent = f;
    b.className = "px-3 py-1 border rounded";
    b.onclick = () => {
      selectedResearchFields.has(f) ? selectedResearchFields.delete(f) : selectedResearchFields.add(f);
      b.classList.toggle("bg-green-600");
      b.classList.toggle("text-white");
      updateCalls();
    };
    c.appendChild(b);
  });
}

/* CALLS */
function updateCalls() {
  const container = document.getElementById("calls-block");
  container.innerHTML = "";

  // Reset selected call when filters change
  selectedCallButton = null;
  document.getElementById("detail-id").textContent = "";
  document.getElementById("detail-title").textContent = "";
  document.getElementById("detail-action").textContent = "";
  document.getElementById("detail-opening").textContent = "";
  document.getElementById("detail-deadline").textContent = "";
  document.getElementById("detail-summary").textContent = "";

  const keywordInput = document
    .getElementById("keyword-input")
    .value
    .toLowerCase()
    .trim();

  const keywordBlocks = keywordInput
    ? keywordInput.split(";").map(k => k.trim()).filter(Boolean)
    : [];

  const results = excelData.filter(r => {
    /* ---------- Discipline filter ---------- */
    if (
      selectedDisciplines.size > 0 &&
      !selectedDisciplines.has(r["Discipline"])
    ) {
      return false;
    }

    /* ---------- Research Field filter ---------- */
    const fields = r["Research Fields"]
      ? r["Research Fields"].split(";").map(f => f.trim())
      : [];

    if (
      selectedResearchFields.size > 0 &&
      !fields.some(f => selectedResearchFields.has(f))
    ) {
      return false;
    }

    /* ---------- Keyword filter ---------- */
    if (keywordBlocks.length > 0) {
      const keywordsCell = (r["Keywords"] || "").toLowerCase();
      if (!keywordBlocks.some(k => keywordsCell.includes(k))) {
        return false;
      }
    }

    return true;
  });

  /* ---------- Counter ---------- */
  document.getElementById("calls-count").textContent = results.length;

  /* ---------- Render Calls ---------- */
  results.forEach(r => {
    const btn = document.createElement("button");
    btn.className =
      "w-full text-left px-3 py-2 border rounded hover:bg-blue-50 transition";

    btn.textContent = `${r["Call ID"]}: ${r["Call Title"]}`;

    btn.onclick = () => {
      // Clear previous selection
      if (selectedCallButton) {
        selectedCallButton.classList.remove("bg-blue-600", "text-white");
      }

      // Mark selected call
      btn.classList.add("bg-blue-600", "text-white");
      selectedCallButton = btn;

      // Populate Call Details panel
      document.getElementById("detail-id").textContent = r["Call ID"];
      document.getElementById("detail-title").textContent = r["Call Title"];
      document.getElementById("detail-action").textContent =
        r["Type of Action"] || "";

      document.getElementById("detail-opening").textContent =
        excelDateToString(r["Opening Date"]);

      document.getElementById("detail-deadline").textContent =
        excelDateToString(r["Deadline(s)"]);

      document.getElementById("detail-summary").textContent =
        r["Summary"] || "";

      // Scroll to Calls block so details are visible
      document
        .getElementById("calls-block")
        .scrollIntoView({ behavior: "smooth", block: "start" });
    };

    container.appendChild(btn);
  });
}

</script>

</body>
</html>
