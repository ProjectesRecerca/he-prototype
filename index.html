
<!--          data-client_id="871231787095-ug0o6pu89sn0t6i97s0nagakohighot8.apps.googleusercontent.com"
          -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Horizon Europe WP26-27</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
</head>

<body class="min-h-screen bg-gray-100 p-6">

  <!-- LOGIN -->
  <div id="login" class="flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-xl p-10 w-full max-w-md text-center">
      <img src="./logo.png" class="mx-auto mb-6 h-20 object-contain" />
      <h1 class="text-2xl font-bold mb-1">Horizon Europe WP26-27</h1>
      <p class="text-sm text-gray-500 mb-8">Call search</p>

      <div
        id="g_id_onload"
        data-client_id="871231787095-ug0o6pu89sn0t6i97s0nagakohighot8.apps.googleusercontent.com"
        data-callback="handleCredentialResponse"
        data-auto_prompt="false">
      </div>

      <div class="flex justify-center">
        <div class="g_id_signin"></div>
      </div>
    </div>
  </div>

  <!-- PRIVATE CONTENT -->
  <div id="private" class="hidden max-w-6xl mx-auto space-y-6">

    <!-- Discipline -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Discipline</h2>
      <div id="discipline-buttons" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Research Fields -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Research Fields</h2>
      <div id="research-buttons" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Calls -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Calls</h2>
      <div id="calls-buttons" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Summary -->
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-2">Summary</h2>
      <div id="summary-content" class="text-gray-700 whitespace-pre-line"></div>
    </div>

  </div>

<script>
let excelData = [];
let selectedDiscipline = null;
let selectedResearchField = null;

function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  const email = payload.email;

  if (!email.endsWith("@upf.edu")) {
    alert("Restricted access to institutional personnel");
    return;
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("private").classList.remove("hidden");

  loadExcelFromRepo("./horizon_calls.xlsx");
}

async function loadExcelFromRepo(path) {
  const res = await fetch(path);
  const buffer = await res.arrayBuffer();
  const wb = XLSX.read(buffer, { type: "array" });
  const ws = wb.Sheets[wb.SheetNames[0]];
  excelData = XLSX.utils.sheet_to_json(ws);

  initDisciplineButtons();
  initResearchFieldButtons();
}

/* ---------------- Discipline ---------------- */

function initDisciplineButtons() {
  const container = document.getElementById("discipline-buttons");
  container.innerHTML = "";

  const disciplines = [...new Set(excelData.map(r => r["Cluster"]).filter(Boolean))].sort();

  disciplines.forEach(d => {
    const btn = createButton(d, "blue", () => {
      selectedDiscipline = selectedDiscipline === d ? null : d;
      initResearchFieldButtons();
      updateCalls();
      highlight(container, selectedDiscipline);
    });
    container.appendChild(btn);
  });
}

/* ---------------- Research Fields ---------------- */

function initResearchFieldButtons() {
  const container = document.getElementById("research-buttons");
  container.innerHTML = "";

  let fields = new Set();

  excelData.forEach(row => {
    if (!selectedDiscipline || row["Cluster"] === selectedDiscipline) {
      if (row["Research Fields"]) {
        row["Research Fields"]
          .split(";")
          .map(f => f.trim())
          .forEach(f => fields.add(f));
      }
    }
  });

  [...fields].sort().forEach(f => {
    const btn = createButton(f, "green", () => {
      selectedResearchField = selectedResearchField === f ? null : f;
      updateCalls();
      highlight(container, selectedResearchField);
    });
    container.appendChild(btn);
  });
}

/* ---------------- Calls ---------------- */

function updateCalls() {
  const container = document.getElementById("calls-buttons");
  container.innerHTML = "";
  document.getElementById("summary-content").innerHTML = "";

  let filtered = excelData.filter(row => {
    if (!selectedResearchField) return true;
    if (!row["Research Fields"]) return false;
    return row["Research Fields"]
      .split(";")
      .map(f => f.trim())
      .includes(selectedResearchField);
  });

  [...new Set(filtered.map(r => r["Call"]).filter(Boolean))].sort()
    .forEach(call => {
      const btn = createButton(call, "purple", () => showSummary(call));
      container.appendChild(btn);
    });
}

/* ---------------- Summary ---------------- */

function showSummary(callName) {
  const row = excelData.find(r => r["Call"] === callName);
  document.getElementById("summary-content").textContent = row?.["Summary"] || "";
}

/* ---------------- Utils ---------------- */

function createButton(text, color, onClick) {
  const btn = document.createElement("button");
  btn.textContent = text;
  btn.className = `px-3 py-1 bg-${color}-100 hover:bg-${color}-200 rounded`;
  btn.onclick = onClick;
  return btn;
}

function highlight(container, value) {
  [...container.children].forEach(b => {
    b.classList.toggle("bg-opacity-80", b.textContent === value);
  });
}
</script>

</body>
</html>
