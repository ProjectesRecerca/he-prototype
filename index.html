
<!--          data-client_id="871231787095-ug0o6pu89sn0t6i97s0nagakohighot8.apps.googleusercontent.com"
          -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Horizon Europe WP26-27</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- ================= LOGIN ================= -->

<div id="login" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-10 rounded-xl shadow-lg text-center w-full max-w-md">
    <img
      src="./logo.png"
      alt="University logo"
      class="mx-auto mb-6 h-20 object-contain"
    />

    <h1 class="text-2xl font-bold mb-2">Horizon Europe WP26-27</h1>
    <p class="text-sm text-gray-500 mb-6">Servei de Recerca</p>

    <div
      id="g_id_onload"
      data-client_id="871231787095-ug0o6pu89sn0t6i97s0nagakohighot8.apps.googleusercontent.com"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>

    <div class="flex justify-center">
      <div class="g_id_signin" data-size="large"></div>
    </div>
  </div>
</div>

<!-- ================= PRIVATE APP ================= -->

<div id="private" class="hidden p-8 max-w-6xl mx-auto">

  <!-- Header -->
  <h1 class="text-3xl font-bold mb-1">Horizon Europe WP26-27</h1>
  <h2 class="text-lg text-gray-600 mb-6">Call Finder</h2>

  <!-- Keyword search -->
  <div class="mb-6">
    <label class="font-semibold">Keyword search</label>
    <input
      id="keyword-input"
      type="text"
      placeholder="energy electrical; machine learning"
      class="w-full p-2 border rounded mt-2"
    />
    <button
      onclick="updateCalls()"
      class="mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
      Search
    </button>
  </div>

  <!-- Discipline -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h3 class="font-bold mb-3">Discipline</h3>
    <div id="discipline-container" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- Research Fields -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h3 class="font-bold mb-3">Research Fields</h3>
    <div id="field-container" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- Calls -->
  <div class="bg-white rounded-xl shadow p-4 mb-6">
    <h3 id="calls-title" class="font-bold mb-3">Calls (0)</h3>
    <div id="calls-container" class="flex flex-col gap-2"></div>
  </div>

  <!-- Summary -->
  <div class="bg-white rounded-xl shadow p-4">
    <h3 class="font-bold mb-3">Summary</h3>
    <p id="summary-content" class="text-gray-700 whitespace-pre-line"></p>
  </div>

</div>

<script>
/* ================= GLOBAL STATE ================= */

let excelData = [];
let selectedDisciplines = new Set();
let selectedResearchFields = new Set();

/* ================= LOGIN ================= */

function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split(".")[1]));
  const email = payload.email;

  if (!email.endsWith("@upf.edu")) {
    alert("Restricted access to institutional personnel");
    return;
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("private").style.display = "block";

  loadExcel();
}

/* ================= EXCEL ================= */

function loadExcel() {
  fetch("./horizon_calls.xlsx")
    .then(res => res.arrayBuffer())
    .then(data => {
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      excelData = XLSX.utils.sheet_to_json(sheet);
      renderDisciplines();
      renderResearchFields();
      updateCalls();
    });
}

/* ================= HELPERS ================= */

function keywordMatchesMulti(cellValue, userInput) {
  if (!cellValue || !userInput) return true;

  const phrases = userInput
    .split(";")
    .map(p => p.trim().toLowerCase())
    .filter(p => p.length > 0);

  if (phrases.length === 0) return true;

  const excelKeywords = cellValue.toLowerCase().split(";");

  return phrases.some(phrase =>
    excelKeywords.some(k => k.includes(phrase))
  );
}

/* ================= RENDERING ================= */

function renderDisciplines() {
  const container = document.getElementById("discipline-container");
  container.innerHTML = "";

  const disciplines = [...new Set(excelData.map(r => r.Cluster))].sort();

  disciplines.forEach(d => {
    const btn = document.createElement("button");
    btn.textContent = d;
    btn.className = "px-3 py-1 rounded border";
    btn.onclick = () => {
      selectedDisciplines.has(d)
        ? selectedDisciplines.delete(d)
        : selectedDisciplines.add(d);
      renderResearchFields();
      updateCalls();
      btn.classList.toggle("bg-blue-600");
      btn.classList.toggle("text-white");
    };
    container.appendChild(btn);
  });
}

function renderResearchFields() {
  const container = document.getElementById("field-container");
  container.innerHTML = "";

  let rows = excelData;
  if (selectedDisciplines.size > 0) {
    rows = rows.filter(r => selectedDisciplines.has(r.Cluster));
  }

  const fields = new Set();
  rows.forEach(r => {
    r["Research Fields"]
      .split(";")
      .map(f => f.trim())
      .forEach(f => fields.add(f));
  });

  [...fields].sort().forEach(f => {
    const btn = document.createElement("button");
    btn.textContent = f;
    btn.className = "px-3 py-1 rounded border";
    btn.onclick = () => {
      selectedResearchFields.has(f)
        ? selectedResearchFields.delete(f)
        : selectedResearchFields.add(f);
      updateCalls();
      btn.classList.toggle("bg-green-600");
      btn.classList.toggle("text-white");
    };
    container.appendChild(btn);
  });
}

function updateCalls() {
  const container = document.getElementById("calls-container");
  container.innerHTML = "";

  const keywordInput =
    document.getElementById("keyword-input").value.trim();

  const filtered = excelData.filter(r => {

    if (
      selectedDisciplines.size > 0 &&
      !selectedDisciplines.has(r.Cluster)
    ) return false;

    if (selectedResearchFields.size > 0) {
      const fields = r["Research Fields"]
        .split(";")
        .map(f => f.trim());
      if (!fields.some(f => selectedResearchFields.has(f))) {
        return false;
      }
    }

    if (keywordInput) {
      return keywordMatchesMulti(r.Keywords, keywordInput);
    }

    return true;
  });

  document.getElementById("calls-title").textContent =
    `Calls (${filtered.length})`;

  filtered.forEach(r => {
    const btn = document.createElement("button");
    btn.className =
      "w-full text-left p-2 border rounded hover:bg-gray-100";
    btn.textContent = `${r["Call ID"]}: ${r["Call Title"]}`;
    btn.onclick = () => {
      document.getElementById("summary-content").textContent =
        r.Summary || "";
    };
    container.appendChild(btn);
  });
}
</script>

</body>
</html>
